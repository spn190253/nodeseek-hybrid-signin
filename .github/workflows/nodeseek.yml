name: NodeSeek æ··åˆç­¾åˆ°å™¨

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ8:30è¿è¡Œ (UTC 00:30)
    - cron: '30 0 * * *'
  workflow_dispatch:
    inputs:
      enable_statistics:
        description: 'æ˜¯å¦å¯ç”¨30å¤©ç»Ÿè®¡'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      enable_selenium:
        description: 'Selenium æ¨¡å¼'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'true'
          - 'false'
      random_mode:
        description: 'ç­¾åˆ°æ¨¡å¼ (false=é¸¡è…¿x5, true=è¯•è¯•æ‰‹æ°”)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  TZ: Asia/Shanghai

jobs:
  signin:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: å®‰è£… Chrome æµè§ˆå™¨
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
        
    - name: å®‰è£… ChromeDriver
      uses: nanasess/setup-chromedriver@v2
      
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: é…ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
        echo "ENABLE_STATISTICS=${{ github.event.inputs.enable_statistics || 'true' }}" >> $GITHUB_ENV
        echo "ENABLE_SELENIUM=${{ github.event.inputs.enable_selenium || 'auto' }}" >> $GITHUB_ENV
        echo "NS_RANDOM=${{ github.event.inputs.random_mode || 'false' }}" >> $GITHUB_ENV
        echo "HEADLESS=true" >> $GITHUB_ENV
        echo "TIMEOUT=60" >> $GITHUB_ENV
        
    - name: æ‰§è¡Œ NodeSeek ç­¾åˆ°
      env:
        NS_COOKIE: ${{ vars.NS_COOKIE }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PROXY_URL: ${{ vars.PROXY_URL }}
        TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œ NodeSeek æ··åˆç­¾åˆ°..."
        echo "ğŸ“Š ç»Ÿè®¡åŠŸèƒ½: $ENABLE_STATISTICS"
        echo "ğŸ¤– Selenium æ¨¡å¼: $ENABLE_SELENIUM" 
        echo "ğŸ² éšæœºæ¨¡å¼: $NS_RANDOM"
        echo "ğŸŒ ä»£ç†è®¾ç½®: ${{ vars.PROXY_URL && 'å·²é…ç½®' || 'æœªé…ç½®' }}"
        echo "ğŸ“¢ TGé€šçŸ¥: ${{ secrets.TG_BOT_TOKEN && secrets.TG_CHAT_ID && 'å·²é…ç½®' || 'æœªé…ç½®' }}"
        echo "ğŸ“ˆ è´¦æˆ·æ•°é‡: $(echo "$NS_COOKIE" | tr '&' '\n' | wc -l)"
        
        python nodeseek_hybrid.py
        
    - name: ä¸Šä¼ è¿è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nodeseek-logs-${{ github.run_number }}
        path: |
          *.log
          screenshots/
        retention-days: 7
        
    - name: å‘é€è¿è¡Œç»“æœé€šçŸ¥
      if: failure()
      run: |
        echo "âŒ NodeSeek ç­¾åˆ°æ‰§è¡Œå¤±è´¥"
        echo "è¯·æ£€æŸ¥ Cookie æ˜¯å¦è¿‡æœŸæˆ–ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
        echo "å¯è®¿é—® Actions é¡µé¢æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
